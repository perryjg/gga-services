<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title>GGA Web Api Example #4</title>
    <script src="jquery-2.1.1.js" type="text/javascript"></script>
    <!-- an inline style sheet to tell the browser how to display our page -->
    <style type="text/css">
        #left { float:left; width:60%;}
        #right { float:right; width:35%;  height:1000px; border-left: 2px inset #cccccc; border-top: 2px inset #cccccc;}
        #pager { background-color:#a6d0cb; }
        #controls { background-color: White;}
        ul { list-style-type:none; 
             
              list-style-position:outside; padding:0; margin:0; }
        li { display:block; list-style-type:none; margin-top:10px;  }
        li a, .caption { color:#0000ff; }
        .caption { padding-left:10px; }
        .even { background-color:#d6f0cb; }
    </style>
    <!-- the code to look up information from GGA and display it on our page-->
    <script type="text/javascript">

        var _index = 0;                                                                                                     //variable to hold the starting index for this page of results
        var _pageSize = 20;                                                                                                  //variable that sets the page size, or number of results per page

        // called when page is loaded for the first time
        $(document).ready(function () {
            // set up session select
            $('#sessionSelect').removeAttr('onchange');
            $('#sessionSelect').change(function () {                                                                        //respond to Session changes by reloading the Members for the new Session
                $('#memberSelect').attr('disabled', 'true');
                var value = $(this).val();
                getMembers(value);
            });

            // set up member select
            $('#memberSelect').removeAttr('onchange');
            $('#memberSelect').change(function () {                                                                         //respond to Member changes by reloading Legislaion for requested
                $('#results').html("");                                                                                     //Member and Session.  Member=0 == All Members
                _index = 0;
                var session = $('#sessionSelect').val();
                var member = $(this).val();
                getLegislation(session, member, _index);
            });

            // call getSessions to get the ball rolling
            getSessions();

        });

        function getSessions() {
            $.ajax({
                url: 'http://webservices.legis.ga.gov/GGAServices/Session/Service.svc/query/json',
                dataType: 'json',
                error: function (xhr, status) { alert(status + '!') },
                contentType: 'application/json; charset=utf-8',
                success: function (sessions) {
                    $.each(sessions, function () {  //the callback function to process results from the server
                        $("#sessionSelect").append($("<option></option>").val(this['Id']).html(this['Description']));
                    });
                    $('#sessionSelect').change();
                }                
            });
        }

        function getMembers(session) {
            $.ajax({  //the callback function to process results from the server
                url: 'http://webservices.legis.ga.gov/GGAServices/Members/Service.svc/query/forSession/' + session + '/json',
                dataType: 'json',
                error: function (xhr, status) { alert(status) },
                contentType: 'application/json; charset=utf-8',
                success: function (members) {
                    var selected = $('#memberSelect').val();
                    $('#memberSelect').html("");
                    $('#memberSelect').append($("<option></option>").val(0).html("All Members"));
                    $.each(members, function () {
                        $("#memberSelect").append($("<option></option>").val(this['Id']).html(this.Name.Last + ', ' + ((this.Name.Nickname != null) ? this.Name.Nickname : this.Name.First)));
                    });
                    $("#memberSelect option[value='" + selected + "']").attr('selected', 'selected');
                    $('#memberSelect').removeAttr('disabled');
                    $('#memberSelect').change();
                }                
            });

        }

        // make ajax call to get a page of legislation from the server
        function getLegislation(session, member, index) {                                                                       //session id, member id, starting index for page
            $('#results').html("");                                                                                             //clear the results div first
            _index = index;                                                                                                     //set _index to variable passed in to this method
            $.ajax({
                url: 'http://webservices.legis.ga.gov/GGAServices/Legislation/Service.svc/query/withPageSize/20/startingAtIndex/' + index + '/json?session=' + session + '&member=' + member,
                dataType: 'json',
                error: function (xhr, status) {
                    alert(status + '!')
                },
                contentType: 'application/json; charset=utf-8',
                success: function (legislation) {    // callback function when Legislation results are returned from GGA, variable legislation will be the results of the service in Json format
                    // the Json element has two properties, Page and Total.  Total is the number of results that satisfy the search conditions,
                    // Page is the current page of results, and is represented as an Array of Legislation objects

                    var even = false;

                    // iterate the Page, output an li element for each piece of legislation
                    $.each(legislation.Page, function () {
                        var dt;
                        switch (this.DocumentType) {// convert int to appropriate string
                            case 1: dt = "SB";
                                break;
                            case 2: dt = "SR";
                                break;
                            case 3: dt = "HR";
                                break;
                            case 4: dt = "HB";
                                break;

                        }
                        var cls = (even) ? "even" : "odd";
                        $("#results").append("<li class='" + cls + "'><a target='_new' id='" + this.Id + "'></a></li>")
                        $("#" + this.Id).attr("href", "http://www.legis.ga.gov/legislation/en-US/display.aspx?legislation=" + this.Id);
                        $('#' + this.Id).html(dt + ' ' + this.Number); // + ':  ' + this.Caption);
                        $('#' + this.Id).after("<span class='caption'>" + this.Caption + "</span>");

                        even = !even
                    });

                    //clear the pager html and build up the new contents
                    $('#pager').html("");
                    var t = +_index + +_pageSize;
                    var td = +_index + +1;
                    $('#pager').html('<a href="" id="prevLink">Prev</a> ' + td + ' to ' + t + ' of ' + legislation.Total + ' <a href="" id="nextLink">Next</a>');
                    var t = +_index + +_pageSize;
                    var nl = 'javascript:getLegislation(' + $('#sessionSelect').val() + ',' + $('#memberSelect').val() + ',' + t + ');'
                    var p = $('#pager');

                    // code to disable/enable nextLink
                    $("#nextLink").click(function (e) {
                        if ($("#nextLink").attr("disabled") == "disabled") {
                            e.preventDefault();
                        }
                    });

                    $('#nextLink').attr('href', nl);
                    if (t > legislation.Total)
                        $('#nextLink').attr('disabled', 'disabled');
                    else
                        $('#nextLink').removeAttr('disabled');

                    var t2 = +_index - +_pageSize;
                    var nl2 = 'javascript:getLegislation(' + $('#sessionSelect').val() + ',' + $('#memberSelect').val() + ',' + t2 + ');'

                    // code to disable/enable prevLink
                    $("#prevLink").click(function (e) {
                        if ($("#prevLink").attr("disabled") == "disabled") {
                            e.preventDefault();
                        }
                    });
                    $('#prevLink').attr('href', nl2);
                    if (t2 >= 0)
                        $('#prevLink').removeAttr('disabled');
                    else
                        $('#prevLink').attr('disabled', 'disabled');

                }                
            });
        }
        
    </script>
</head>

<body>

    
    <div id="left">
    <h1>Georgia General Assembly Web Api Example #4</h1>
    <p>This HTML page shows an example of how to display content from the GGA web services on your website.  It uses jQuery and Json with Ajax.</p>
    <p>This example further demonstrates how you can implement paging to allow the user to move between pages of the Search Results.</p>
    <p>You could also choose to use the POST method for the request, as shown in examples #2 and #3.</p>
    </div>
    <!-- the div element below will be filled in dynamically using javascript, Ajax, jQuery, and Json-->
    <div id="right">
        <div id="controls">        
            <select id="sessionSelect"></select>
            <select id="memberSelect"></select>
        </div>    
        <div id="pager"></div>
        <ul id="results"></ul>        
    </div>
    
</body>
</html>
